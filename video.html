<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>UltraSaver - One Click Download</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #05000a;
            color: white;
            -webkit-tap-highlight-color: transparent;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .gradient-text {
            background: linear-gradient(to right, #00d2ff, #928DAB);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.3s;
        }
    </style>
</head>
<body class="min-h-screen p-4">

    <div class="max-w-2xl mx-auto pt-8">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-black gradient-text mb-2">ULTRA SAVER</h1>
            <p class="text-gray-400 text-sm">One-Click Direct Download</p>
        </div>

        <!-- Input Section -->
        <div class="glass-card rounded-3xl p-4 md:p-6 mb-4">
            <div class="flex flex-col md:flex-row gap-3 mb-4">
                <input
                    type="text"
                    id="urlInput"
                    placeholder="Video link paste karo..."
                    class="flex-1 bg-white/5 border border-white/10 rounded-2xl py-4 px-4 text-white placeholder-gray-500 outline-none focus:border-cyan-400"
                />
                <button
                    onclick="searchVideo()"
                    class="bg-gradient-to-r from-cyan-500 to-blue-600 px-8 py-4 rounded-2xl font-bold text-white hover:shadow-lg active:scale-95 transition-all"
                >
                    <i class="fa-solid fa-search mr-2"></i>Search
                </button>
            </div>

            <!-- Platform Icons -->
            <div class="flex gap-2 justify-center">
                <div id="yt-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-white/5 text-gray-500">YouTube</div>
                <div id="ig-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-white/5 text-gray-500">Instagram</div>
                <div id="tk-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-white/5 text-gray-500">TikTok</div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorBox" class="hidden bg-red-500/10 border border-red-500/50 rounded-2xl p-4 mb-4">
            <p id="errorText" class="text-red-400 text-sm text-center"></p>
        </div>

        <!-- Loading -->
        <div id="loadingBox" class="hidden glass-card rounded-3xl p-12 border border-white/10 text-center mb-4">
            <i class="fa-solid fa-spinner fa-spin text-4xl text-cyan-400 mb-4"></i>
            <p class="text-cyan-400 font-bold">Video dhoondh rahe hain...</p>
        </div>

        <!-- Results -->
        <div id="resultsBox" class="hidden glass-card rounded-3xl p-4 md:p-6 border border-white/10 mb-4">
            <img id="thumbnail" class="w-full rounded-2xl mb-4 hidden" />
            <div id="videoList" class="space-y-3"></div>
            
            <div class="mt-6 p-4 bg-cyan-500/10 border border-cyan-500/30 rounded-xl">
                <p class="text-cyan-400 text-xs text-center">
                    ðŸ’¡ <strong>Tip:</strong> Agar download slow hai to quality kam karo. Higher quality = larger file size.
                </p>
            </div>
        </div>

        <!-- Instructions -->
        <div id="instructionsBox" class="glass-card rounded-3xl p-6 md:p-8 border border-white/10 text-center">
            <i class="fa-solid fa-rocket text-5xl md:text-6xl text-cyan-400 mb-4"></i>
            <h3 class="text-lg md:text-xl font-bold text-white mb-4">Ek Click Mein Download!</h3>
            <ol class="text-gray-400 text-sm space-y-2 text-left max-w-md mx-auto">
                <li>1. YouTube/Instagram/TikTok se video link copy karo</li>
                <li>2. Upar paste karke Search dabao</li>
                <li>3. Quality select karo</li>
                <li>4. <strong>Download button dabao aur wait karo</strong></li>
                <li>5. <span class="text-cyan-400">Automatic download shuru ho jayega! ðŸš€</span></li>
            </ol>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
    // Firebase Config
    const fbConfig = { 
        apiKey: "AIzaSyDI7v-5DoTUWZBhajcpZk6ed9rH2GcAqLw", 
        databaseURL: "https://a2ztools-6ea22-default-rtdb.asia-southeast1.firebasedatabase.app" 
    };
    firebase.initializeApp(fbConfig);
    const db = firebase.database();
    let apiKey = '';

    db.ref('settings/videoKey').on('value', (snapshot) => {
        apiKey = snapshot.val();
    });

    // Platform Detection
    document.getElementById('urlInput').addEventListener('input', (e) => {
        const url = e.target.value.toLowerCase();
        const ytBadge = document.getElementById('yt-badge');
        const igBadge = document.getElementById('ig-badge');
        const tkBadge = document.getElementById('tk-badge');

        ytBadge.className = igBadge.className = tkBadge.className = 'px-3 py-1 rounded-full text-xs font-bold bg-white/5 text-gray-500';

        if (url.includes('youtube') || url.includes('youtu.be')) {
            ytBadge.className = 'px-3 py-1 rounded-full text-xs font-bold bg-red-500/20 text-red-400 border border-red-500/50';
        } else if (url.includes('instagram')) {
            igBadge.className = 'px-3 py-1 rounded-full text-xs font-bold bg-pink-500/20 text-pink-400 border border-pink-500/50';
        } else if (url.includes('tiktok')) {
            tkBadge.className = 'px-3 py-1 rounded-full text-xs font-bold bg-white/20 text-white border border-white/50';
        }
    });

    // Search Video
    async function searchVideo() {
        const url = document.getElementById('urlInput').value.trim();
        
        if (!url) {
            showError('Link paste karo pehle!');
            return;
        }

        if (!apiKey) {
            showError('API Key load nahi hua! Page refresh karo.');
            return;
        }

        hideAll();
        document.getElementById('loadingBox').classList.remove('hidden');

        try {
            const response = await fetch('https://social-download-all-in-one.p.rapidapi.com/v1/social/autolink', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-RapidAPI-Key': apiKey,
                    'X-RapidAPI-Host': 'social-download-all-in-one.p.rapidapi.com'
                },
                body: JSON.stringify({ url: url })
            });

            const data = await response.json();

            if (data.medias && data.medias.length > 0) {
                showResults(data);
            } else {
                showError('Video nahi mila! Link check karo.');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('API Error! Network check karo.');
        }

        document.getElementById('loadingBox').classList.add('hidden');
    }

    // Show Results
    function showResults(data) {
        hideAll();
        
        const resultsBox = document.getElementById('resultsBox');
        const thumbnail = document.getElementById('thumbnail');
        const videoList = document.getElementById('videoList');

        if (data.picture || data.thumbnail) {
            thumbnail.src = data.picture || data.thumbnail;
            thumbnail.classList.remove('hidden');
        }

        videoList.innerHTML = '';
        data.medias.forEach((video, index) => {
            const quality = video.quality || 'Unknown';
            const extension = video.extension || 'mp4';
            const videoUrl = video.url;
            const btnId = `dl-btn-${index}`;

            const card = document.createElement('div');
            card.className = 'bg-white/5 rounded-2xl p-4 border border-white/10';
            card.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="text-cyan-400 font-black text-sm uppercase">${quality}</div>
                        <div class="text-gray-500 text-xs mt-1">${extension.toUpperCase()}</div>
                    </div>
                    <button 
                        id="${btnId}"
                        data-url="${videoUrl}"
                        data-quality="${quality}"
                        onclick="downloadVideoBlob('${btnId}')"
                        class="bg-cyan-600 hover:bg-cyan-500 px-6 py-3 rounded-xl font-bold text-sm text-white transition-all active:scale-95 flex items-center gap-2"
                    >
                        <i class="fa-solid fa-download"></i>
                        <span>Download</span>
                    </button>
                </div>
                <div id="progress-${btnId}" class="hidden mt-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-gray-400">Downloading...</span>
                        <span id="percent-${btnId}" class="text-xs text-cyan-400 font-bold">0%</span>
                    </div>
                    <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                        <div id="bar-${btnId}" class="h-full bg-gradient-to-r from-cyan-500 to-blue-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            `;
            videoList.appendChild(card);
        });

        resultsBox.classList.remove('hidden');
    }

    // MAIN DOWNLOAD FUNCTION - BLOB METHOD WITH MULTIPLE PROXIES
    async function downloadVideoBlob(btnId) {
        const btn = document.getElementById(btnId);
        const videoUrl = btn.getAttribute('data-url');
        const quality = btn.getAttribute('data-quality');
        const progressContainer = document.getElementById(`progress-${btnId}`);
        const progressBar = document.getElementById(`bar-${btnId}`);
        const percentText = document.getElementById(`percent-${btnId}`);

        // Disable button
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Starting...';
        progressContainer.classList.remove('hidden');

        // List of CORS proxies to try
        const proxies = [
            '', // Try direct first
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest=',
        ];

        let downloadSuccess = false;

        for (let i = 0; i < proxies.length; i++) {
            if (downloadSuccess) break;

            const proxy = proxies[i];
            const url = proxy ? proxy + encodeURIComponent(videoUrl) : videoUrl;

            try {
                console.log(`Trying ${proxy ? 'proxy ' + (i) : 'direct'}:`, url);
                
                btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i>Method ${i + 1}/${proxies.length}`;
                
                // Fetch with timeout
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 30000); // 30 sec timeout

                const response = await fetch(url, { 
                    signal: controller.signal,
                    mode: proxy ? 'cors' : 'no-cors'
                });
                
                clearTimeout(timeout);

                if (!response.ok && !proxy) {
                    throw new Error('Direct fetch failed');
                }

                // Get total size if available
                const contentLength = response.headers.get('content-length');
                const total = contentLength ? parseInt(contentLength) : 0;

                // Read response as blob with progress
                const reader = response.body.getReader();
                const chunks = [];
                let receivedLength = 0;

                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    chunks.push(value);
                    receivedLength += value.length;

                    // Update progress
                    if (total > 0) {
                        const percent = Math.round((receivedLength / total) * 100);
                        progressBar.style.width = percent + '%';
                        percentText.textContent = percent + '%';
                    } else {
                        // Unknown size - show activity
                        const fakePercent = Math.min(90, Math.round(receivedLength / 100000));
                        progressBar.style.width = fakePercent + '%';
                        percentText.textContent = 'Downloading...';
                    }
                }

                // Combine chunks into blob
                const blob = new Blob(chunks);
                console.log('Download complete. Blob size:', blob.size);

                // Validate blob size (at least 10KB)
                if (blob.size < 10000) {
                    throw new Error('File too small - likely failed');
                }

                // Create download link
                progressBar.style.width = '100%';
                percentText.textContent = '100%';
                btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Saving...';

                const blobUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = `A2Z_${quality}_${Date.now()}.mp4`;
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(blobUrl);
                }, 100);

                // Success!
                btn.innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i>Downloaded!';
                btn.classList.remove('bg-cyan-600');
                btn.classList.add('bg-green-600');
                
                downloadSuccess = true;

                setTimeout(() => {
                    btn.innerHTML = '<i class="fa-solid fa-download mr-2"></i>Download Again';
                    btn.classList.remove('bg-green-600');
                    btn.classList.add('bg-cyan-600');
                    btn.disabled = false;
                    progressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                }, 3000);

            } catch (error) {
                console.error(`Method ${i + 1} failed:`, error);
                
                // Continue to next proxy
                if (i < proxies.length - 1) {
                    continue;
                } else {
                    // All methods failed
                    btn.innerHTML = '<i class="fa-solid fa-exclamation-triangle mr-2"></i>Failed';
                    btn.classList.add('bg-red-600');
                    
                    setTimeout(() => {
                        // Fallback: Open in new tab
                        alert('Direct download failed!\n\nVideo new tab mein khul raha hai.\n\nMobile: Long-press â†’ Download\nDesktop: Right-click â†’ Save video as');
                        window.open(videoUrl, '_blank');
                        
                        btn.innerHTML = '<i class="fa-solid fa-redo mr-2"></i>Try Again';
                        btn.classList.remove('bg-red-600');
                        btn.classList.add('bg-cyan-600');
                        btn.disabled = false;
                        progressContainer.classList.add('hidden');
                    }, 2000);
                }
            }
        }
    }

    // Helper Functions
    function showError(message) {
        hideAll();
        document.getElementById('errorBox').classList.remove('hidden');
        document.getElementById('errorText').textContent = message;
    }

    function hideAll() {
        document.getElementById('errorBox').classList.add('hidden');
        document.getElementById('loadingBox').classList.add('hidden');
        document.getElementById('resultsBox').classList.add('hidden');
        document.getElementById('instructionsBox').classList.add('hidden');
    }
</script>

</body>
</html>
