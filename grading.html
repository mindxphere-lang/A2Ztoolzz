<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>A2Z Studio - Generative Vision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet"/>
    <style>
        :root { --accent: #007aff; --bg: #000; --panel: #0a0a0a; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; height: 100vh; }
        
        .viewport { flex-grow: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000; overflow: hidden; }
        
        /* Masking Canvas Layer */
        #canvas-wrapper { position: relative; display: flex; align-items: center; justify-content: center; max-width: 100%; max-height: 100%; }
        #main-img { max-width: 100%; max-height: 65vh; border-radius: 4px; object-fit: contain; }
        #mask-canvas { position: absolute; top: 0; left: 0; cursor: crosshair; touch-action: none; z-index: 10; }

        /* Control Panel */
        .controls-panel { height: 35vh; background: var(--panel); border-top: 1px solid #1a1a1a; display: flex; flex-direction: column; }
        
        .tabs-nav { display: flex; justify-content: center; gap: 40px; border-bottom: 1px solid #111; padding: 12px 0; }
        .tab-item { font-size: 11px; font-weight: 800; color: #444; text-transform: uppercase; cursor: pointer; letter-spacing: 1px; }
        .tab-item.active { color: white; border-bottom: 2px solid var(--accent); }

        .tools-area { flex: 1; overflow-y: auto; padding: 25px; }
        
        /* Generative Fill UI */
        .gen-box { background: #111; border-radius: 20px; padding: 20px; border: 1px solid #1a1a1a; }
        #prompt-input { background: #000; border: 1px solid #222; color: white; padding: 12px; width: 100%; border-radius: 12px; font-size: 13px; margin-top: 10px; outline: none; }
        #prompt-input:focus { border-color: var(--accent); }

        /* Sliders */
        .slider-row { margin-bottom: 25px; max-width: 500px; margin-left: auto; margin-right: auto; }
        .slider-label { display: flex; justify-content: space-between; font-size: 10px; font-weight: 700; color: #666; text-transform: uppercase; margin-bottom: 8px; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: #222; height: 2px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: white; border-radius: 50%; border: 4px solid var(--panel); }

        .btn-neural { background: var(--accent); color: white; font-weight: 900; text-transform: uppercase; font-size: 11px; letter-spacing: 2px; padding: 16px; border-radius: 15px; width: 100%; margin-top: 15px; transition: 0.3s; }
        .btn-neural:active { transform: scale(0.96); opacity: 0.8; }

        .loader { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; flex-direction: column; items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="flex flex-col h-screen">
        <!-- Top Navigation -->
        <header class="p-4 flex justify-between items-center border-b border-white/5">
            <a href="index.html" class="text-white/30"><i class="fa-solid fa-chevron-left"></i></a>
            <h1 class="text-[10px] font-black tracking-[0.5em] uppercase opacity-50">Generative Vision Pro</h1>
            <button onclick="downloadResult()" class="text-blue-500 font-bold text-[11px] uppercase">Save</button>
        </header>

        <!-- Viewport -->
        <main class="viewport">
            <input type="file" id="file-input" class="hidden" onchange="initEditor(event)">
            
            <div id="welcome-ui" onclick="document.getElementById('file-input').click()" class="text-center cursor-pointer">
                <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4 border border-white/10">
                    <i class="fa-solid fa-plus text-white/40"></i>
                </div>
                <p class="text-[9px] font-black uppercase text-white/30 tracking-widest">Select Neural Input</p>
            </div>

            <div id="canvas-wrapper" class="hidden">
                <img id="main-img" src="">
                <!-- Transparent Masking Layer -->
                <canvas id="mask-canvas"></canvas>
            </div>

            <div id="loader" class="loader">
                <div class="w-10 h-10 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mb-6"></div>
                <p class="text-[10px] font-black uppercase tracking-[0.4em] text-blue-500 animate-pulse">Generative Fill Processing...</p>
            </div>
        </main>

        <!-- Bottom Controls -->
        <div id="controls" class="controls-panel hidden">
            <div class="tabs-nav">
                <div class="tab-item active" onclick="switchTab('gen', this)">AI Generative</div>
                <div class="tab-item" onclick="switchTab('light', this)">Lightroom Edit</div>
            </div>

            <div class="tools-area">
                <!-- AI GENERATIVE TAB -->
                <div id="sec-gen" class="tab-content">
                    <div class="gen-box">
                        <div class="flex justify-between items-center">
                            <p class="text-[10px] font-black text-blue-500 uppercase">Brush over object</p>
                            <button onclick="clearMask()" class="text-[9px] text-white/30 uppercase">Clear Mask</button>
                        </div>
                        <input type="text" id="prompt-input" placeholder="What to fill? (e.g. 'sunset', 'blue jacket' or 'remove')">
                        <div class="mt-4">
                            <div class="slider-label">Brush Size <span id="b-val">30</span></div>
                            <input type="range" min="10" max="150" value="30" oninput="brushSize=this.value; document.getElementById('b-val').innerText=this.value">
                        </div>
                        <button onclick="applyGenerativeAI()" class="btn-neural">Run Neural Engine</button>
                    </div>
                </div>

                <!-- LIGHTROOM TAB -->
                <div id="sec-light" class="tab-content hidden">
                    <div class="slider-row">
                        <div class="slider-label">Exposure <span id="v-br">0</span></div>
                        <input type="range" id="br" min="-100" max="100" value="0" oninput="updateFilters()">
                    </div>
                    <div class="slider-row">
                        <div class="slider-label">Contrast <span id="v-co">0</span></div>
                        <input type="range" id="co" min="-100" max="100" value="0" oninput="updateFilters()">
                    </div>
                    <div class="slider-row">
                        <div class="slider-label">Saturation <span id="v-sa">100</span></div>
                        <input type="range" id="sa" min="0" max="200" value="100" oninput="updateFilters()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script>
        // FIREBASE CONFIG
        const firebaseConfig = { apiKey: "AIzaSyDI7v-5DoTUWZBhajcpZk6ed9rH2GcAqLw", databaseURL: "https://a2ztools-6ea22-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig); const db = firebase.database();

        let apiKeys = {};
        db.ref('keys').on('value', s => apiKeys = s.val() || {});

        let publicId = "", brushSize = 30, painting = false;
        let canvas = document.getElementById('mask-canvas'), ctx = canvas.getContext('2d');
        const CLOUD_NAME = "dgikim3w1", UPLOAD_PRESET = "a2z_preset";

        async function initEditor(e) {
            const file = e.target.files[0]; if(!file) return;
            showLoader(true);
            const formData = new FormData(); formData.append("file", file); formData.append("upload_preset", UPLOAD_PRESET);

            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: formData });
            const data = await res.json();
            publicId = data.public_id;

            const img = document.getElementById('main-img');
            img.src = data.secure_url;
            img.onload = () => {
                canvas.width = img.clientWidth; canvas.height = img.clientHeight;
                document.getElementById('welcome-ui').classList.add('hidden');
                document.getElementById('canvas-wrapper').classList.remove('hidden');
                document.getElementById('controls').classList.remove('hidden');
                setupBrushing(); showLoader(false);
            };
        }

        function setupBrushing() {
            ctx.strokeStyle = "rgba(0, 122, 255, 0.5)"; ctx.lineWidth = brushSize; ctx.lineCap = "round";
            const start = (e) => { painting = true; draw(e); }
            const move = (e) => { if(painting) draw(e); }
            const end = () => { painting = false; ctx.beginPath(); }
            canvas.onmousedown = start; canvas.onmousemove = move; canvas.onmouseup = end;
            canvas.ontouchstart = (e) => start(e.touches[0]); canvas.ontouchmove = (e) => { e.preventDefault(); move(e.touches[0]); }; canvas.ontouchend = end;
        }

        function draw(e) {
            const rect = canvas.getBoundingClientRect();
            ctx.lineWidth = brushSize;
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function switchTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById('sec-' + id).classList.remove('hidden'); btn.classList.add('active');
        }

        function updateFilters() {
            const br = document.getElementById('br').value, co = document.getElementById('co').value, sa = document.getElementById('sa').value;
            document.getElementById('v-br').innerText = br; document.getElementById('v-co').innerText = co; document.getElementById('v-sa').innerText = sa;
            document.getElementById('main-img').style.filter = `brightness(${100 + parseInt(br)}%) contrast(${100 + parseInt(co)}%) saturate(${sa}%)`;
        }

        async function applyGenerativeAI() {
            const prompt = document.getElementById('prompt-input').value;
            if(!prompt) return alert("Describe what to fill or type 'remove'");
            showLoader(true);

            // Cloudinary Generative Fill Transformation
            // e_gen_fill:prompt_... OR e_gen_remove:prompt_...
            let tr = prompt.toLowerCase() === 'remove' ? `e_gen_remove:prompt_object` : `e_gen_fill:prompt_${prompt}`;
            
            const finalUrl = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${tr}/${publicId}?${Date.now()}`;
            const img = document.getElementById('main-img');
            img.src = finalUrl;
            img.onload = () => { clearMask(); showLoader(false); };
        }

        function clearMask() { ctx.clearRect(0,0,canvas.width,canvas.height); }
        function showLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
        function downloadResult() { window.open(document.getElementById('main-img').src, '_blank'); }
    </script>
</body>
</html>
